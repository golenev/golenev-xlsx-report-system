# Test Report System

Полнофункциональная система ведения регрессионных тестов с web-интерфейсом в стиле Google Sheets.

## Состав проекта

- **backend/** — Kotlin + Spring Boot, PostgreSQL, Flyway, экспорт Excel
- **frontend/** — React SPA (Vite)
- **config/column-config.json** — конфигурация фиксированных ширин колонок
- **docker-compose.yml** — единая точка запуска инфраструктуры и сервисов

## Необходимые инструменты

- Docker + Docker Compose — достаточно, чтобы собрать и запустить всё приложение без установки Java и Node.js на хостовую машину.
- Java 17+, Gradle 8.x и Node.js 18+ с npm 9+ нужны только если планируется локальная разработка без Docker.

## Быстрый запуск всего решения (единый контейнер)

Команда ниже собирает фронтенд и backend в один образ и поднимает его вместе с PostgreSQL. Выполняйте из корня репозитория:

```bash
docker compose up -d
```

Что произойдёт:
- Соберётся единый образ `app`, внутри которого Spring Boot отдаёт API и собранный фронтенд (статические файлы прокладываются в jar на этапе сборки).
- Поднимется база PostgreSQL на порту `55432` с сохранением данных в volume `db-data`.
- Приложение будет доступно по адресу `http://localhost:18080` (фронт и API на одном порту).

Остановить сервисы можно командой:
```bash
docker compose down
```
Если нужно удалить данные базы, используйте `docker compose down -v`.

### Как применить изменения логики в контейнере

После любых правок в коде (backend или frontend), чтобы они попали в запущенный контейнер,
пересоберите образ и перезапустите сервис:

```bash
docker compose up -d --build
```

Эта команда соберёт новый образ `app` и плавно перезапустит контейнер с обновлённой логикой.
Удалять volume с базой данных не требуется, если не менялась схема БД.

### Как протестировать фичу из конкретной ветки

Если фича лежит в отдельной ветке (например, в PR), для проверки достаточно переключиться на неё и пересобрать контейнеры:

1. Обновите локальный код нужной ветки:
   ```bash
   git fetch
   git checkout feature/my-branch
   git pull
   ```
2. Пересоберите образы и перезапустите сервисы (сделает сборку именно из текущей ветки):
   ```bash
   docker compose up -d --build
   ```

Docker Compose собирает образ из исходников, которые находятся в рабочей копии — поэтому после `git checkout` образ автоматически строится из кода выбранной ветки. Дополнительно ничего настраивать не нужно. Если ранее был запущен другой вариант приложения, при необходимости предварительно выполните `docker compose down`.


Если хотите разрабатывать с hot-reload, оставьте БД в Docker, а фронтенд и backend запускайте локально:

1. **Поднять только БД:**
   ```bash
   docker compose up -d db
   ```
2. **Запустить backend (локально):**
   ```bash
   cd backend
   ./gradlew bootRun
   ```
3. **Запустить frontend (локально):**
   ```bash
   cd frontend
   npm install
   npm run dev
   ```
   Vite поднимет dev-сервер на `http://localhost:5173` и будет проксировать `/api` на `http://localhost:18080`.

### Самостоятельный запуск PostgreSQL

При желании можно обойтись без Docker и использовать собственный сервер БД. В этом случае пропустите шаг 1, настройте доступ к базе и передайте переменные окружения `DB_URL`, `DB_USERNAME`, `DB_PASSWORD` перед запуском backend.

## Назначение Dockerfile'ов

- **Dockerfile** (в корне) — собирает фронтенд, прокладывает статические файлы в Spring Boot JAR и запускает единый контейнер, отдающий и API, и SPA на порту `18080`.
- **backend/Dockerfile** — многоэтапная сборка для отдельного деплоя backend (без фронтенда внутри).
- **frontend/Dockerfile** — сборка production-бандла Vite для отдельного контейнерного деплоя SPA.

Отдельные Dockerfile для backend и frontend пригодятся, если нужно разворачивать их по отдельности. Для локальной разработки всё ещё можно запускать сервисы напрямую из исходников.

## Переменные окружения backend

| Переменная           | Назначение                                            | Значение по умолчанию |
|----------------------|--------------------------------------------------------|------------------------|
| `DB_URL`             | JDBC-строка подключения к PostgreSQL                  | `jdbc:postgresql://localhost:55432/test_report` |
| `DB_USERNAME`        | Пользователь PostgreSQL                               | `report` |
| `DB_PASSWORD`        | Пароль PostgreSQL                                     | `report` |
| `COLUMN_CONFIG_PATH` | Путь к JSON с ширинами колонок                        | `classpath:config/column-config.json` |
| `PORT`               | Порт HTTP-сервера Spring Boot                         | `18080` |

## Frontend

При локальном запуске Vite использует прокси на `http://localhost:18080`. Если backend запущен на другом хосте/порту, укажите `VITE_API_BASE_URL`:
```bash
VITE_API_BASE_URL="http://example.com:18080" npm run dev
```
