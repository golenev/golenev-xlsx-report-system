# User Stories

## ✅ UI User Stories

### UI-1. Добавление новой строки

- Пользователь создаёт черновую строку через кнопку **Add Row**; при наличии пустого черновика или активного режима редактирования кнопка блокируется.
- В столбце **Test ID** вводится уникальное значение (триммируется). Если ID уже есть среди сохранённых строк или других черновиков, появляется попап «Duplicate Test ID …» и сохранение запрещено.
- При сохранении проверяются обязательные поля: `Category`, `Short Title`, `Scenario`, `General Test Status`. Для каждого пустого поля показывается сообщение вида «Required field <fieldName>».
- Остальные поля заполняются по желанию; при сохранении пустое поле Ready Date заменяется текущей датой, Priority по умолчанию — `Medium`.

### UI-2. Фиксация Ready Date

- Ready Date устанавливается только при создании строки: пользователь может задать дату вручную, либо она заполнится текущей автоматически.
- При последующем редактировании ячейки Ready Date значение в базе не изменится — после перезагрузки таблицы сохранится исходная дата создания.

### UI-3. Редактирование существующих записей

- Test ID не редактируется.
- Остальные поля редактируются инлайн; сохранение происходит по блюру ячейки или при выборе значения в выпадающем списке.
- Пока строка находится в режиме редактирования, кнопка **Add Row** остаётся заблокированной.
- Поле **General Test Status** заполняется только валидными статусами из списка, **Priority** выбирается из фиксированного набора.

### UI-4. Удаление записи

- Кнопка ✕ удаляет строку после подтверждения диалога браузера. При успешном удалении таблица перезагружается.

### UI-5. Сортировка таблицы

- Таблица всегда отсортирована по **Test ID**: сначала по числовой части, затем по суффиксу после дефиса, затем по лексикографическому порядку.
- После добавления, изменения или удаления сортировка применяется автоматически.

### UI-6. Экспорт данных

- Кнопка **Export to Excel** выгружает текущие данные таблицы с сохранением ширин колонок из конфигурации.

### UI-7. Управление регрессом

- В заголовке колонки **Regress Run** доступно управление регрессионным прогоном.
- Запуск требует указать `Release name`; если регресс уже запущен, кнопка запуска недоступна.
- Пока регресс в статусе **RUNNING**, колонка Regress Run разблокирована: для каждой строки выбираются статусы `PASSED`/`FAILED`/`SKIPPED`.
- Попытка остановить регресс при незаполненных статусах показывает предупреждение и блокирует завершение.
- Остановка сохраняет результаты и снова блокирует колонку; отмена сбрасывает состояние до **IDLE** без сохранения результатов.

## ✅ API User Stories

### API-1. Получение списка тестов

- `GET /api/tests` возвращает отсортированный список тестов и объект `columnConfig` с ширинами колонок.

### API-2. Создание или обновление теста

- `POST /api/tests` принимает JSON с полями тест-кейса; `testId`, `category`, `shortTitle`, `scenario`, `generalStatus`, `priority` обязательны при создании новой записи.
- Для обновления можно передавать только изменённые поля — пустые обязательные поля заполняются значениями из существующей записи.
- Значения `generalStatus` и `priority` валидируются по предопределённым справочникам; при ошибке возвращается 400 с описанием.

### API-3. Пакетная загрузка

- `POST /api/tests/batch` принимает массив записей и применяет ту же валидацию/логику upsert, что и одиночный запрос.

### API-4. Обработка дубликатов Test ID

- При передаче существующего `testId` запись перезаписывается без ошибки; `readyDate` при этом не меняется.
- Отсутствие `testId` возвращает 400 с сообщением `Required field testId is missing`.

### API-5. Управление Ready Date

- При создании, если поле `readyDate` не передано или пустое, в базе сохраняется текущая дата; если указана валидная ISO-дата, сохраняется она.
- При обновлении уже существующей записи `readyDate` не изменяется, даже если значение передано в запросе.

### API-6. Удаление теста

- `DELETE /api/tests/{testId}` удаляет запись; при отсутствии теста возвращает 404.

### API-7. Экспорт в Excel

- `GET /api/tests/export/excel` отдаёт файл XLSX с данными и ширинами колонок из конфигурации.

### API-8. Управление регрессом

- `POST /api/regressions/start` стартует прогон: требуется непустой `releaseName`, отсутствие другого запущенного регресса и уникальность имени релиза.
- `POST /api/regressions/stop` завершает прогон только при статусе **RUNNING** и наличия статуса для каждого теста из списка; допустимые значения — `PASSED`/`FAILED`/`SKIPPED`.
- `POST /api/regressions/cancel` отменяет запущенный прогон и переводит состояние в **IDLE** (если результаты не сохранялись, запись удаляется).
- Результаты остановленного прогона сохраняют метаданные (`regressionDate`, `releaseName`) и статусы всех тестов.

### API-9. Текущее состояние регресса

- `GET /api/regressions/current` возвращает статус (`RUNNING`/`COMPLETED`/`IDLE`), дату регресса, имя релиза и ранее сохранённые результаты для запущенного прогона.

### API-10. Конфигурация колонок

- `GET /api/config/columns` отдаёт ширины колонок, которые применяются в UI и при экспорте.
