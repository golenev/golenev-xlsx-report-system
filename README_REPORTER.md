# Как загрузить автоматизированные тест-кейсы в репортер

Инструкция описывает единственный поток: отправить уже готовые результаты автоматизированных тестов в сервер репортера без запуска регресса. Требуется лишь собрать список тестов, соответствующий структуре моделей ниже, и выполнить один POST-запрос.

## Требуемая модель запроса
Отправляемый JSON нужно получить из уже сгенерированных Allure-отчетов: достаточно спарсить итоговые JSON-файлы и собрать по
4 поля ниже. Они соответствуют Kotlin-моделям на сервере:

```kotlin
// Корневой объект запроса
// POST /api/tests/batch
// content-type: application/json

data class BatchRequest(
    val items: List<TestCaseItem>,
)

data class TestCaseItem(
    val testId: String,      // Берётся из аннотации AllureId
    val category: String,    // Группа тестов/категория фич. Берётся из @DisplayName над классом
    val shortTitle: String,  // Короткое имя теста. Берётся из @DisplayName над тестом
    val scenario: String,    // Человеко-читаемый сценарий
)
```

После загрузки тестов в UI появятся и другие поля, предварительно заполненные дефолтами. Их предполагается проставлять вручную
во время ревью сценария или обсуждения с менеджерами:

- `issueLink`: ссылка на задачу/требование.
- `readyDate`: дата готовности. Отправлять не нужно — сервер заполнит при первом добавлении и больше не изменит.
- `generalStatus`: автоматически выставляется в `"Готово"`.
- `notes`: дополнительные комментарии, можно заполнить прямо в UI.
- `priority`: например, `"Medium"`; по умолчанию medium, далее редактируется через UI.
- `runStatus`: заполняется автоматически при регрессе, вне регресса не учитывается.

При каждой новой загрузке обновляются только `category`, `shortTitle` и `scenario`; остальные значения остаются неизменными, так
как в артефактах Allure их нет и по задумке их редактируют вручную. Сценарии также можно добавлять или удалять вручную в UI.

Есть режим прогона тестов при запущенном регрессе. Регресс можно стартовать вручную через UI или API-запрос; при регрессе
дополнительно проставляется статус теста. Завершить регресс можно только после выставления статусов для всех тестов (даже не
участвовавших). После завершения снимок регресса сохраняется в базу, а в шапке главной страницы доступна инфографика по всем
предыдущим регрессам. Текущий набор тест-кейсов и снапшот любого регресса можно выгрузить отдельными файлами в формате XLSX.

## Правило для `AllureId`
Каждый автотест должен быть аннотирован `@AllureId()` с уникальным значением. Для параметризованного теста достаточно одной аннотации: при парсинге каждому кейсу автоматически добавится постфикс с индексом прогона. Например, `@AllureId(234)` превратится в `234-1`, `234-2` и т. д. для отдельных итераций.

## Пример запроса с двумя кейсами
Пример `curl`, отправляющий два тест-кейса одним батчем. Замените адрес сервера и значения полей при необходимости.

```bash
curl -X POST \
  "http://localhost:18080/api/tests/batch" \
  -H "Content-Type: application/json" \
  -d '{
    "items": [
      {
        "testId": "234-1",
        "category": "checkout",
        "shortTitle": "Успешная оплата картой",
        "scenario": "1) открыть корзину; 2) оплатить картой; 3) убедиться, что статус оплаты success"
      },
      {
        "testId": "234-2",
        "category": "checkout",
        "shortTitle": "Оплата картой с истекшим сроком",
        "scenario": "1) открыть корзину; 2) оплатить истекшей картой; 3) получить ошибку об истечении срока"
      }
    ]
  }'
```

Отправка такого запроса добавит оба тест-кейса на сервер. При успешном ответе (HTTP 200) они появятся в интерфейсе репортера.
